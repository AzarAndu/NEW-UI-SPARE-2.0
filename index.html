<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Spare Parts Data</title>

<style>
:root{
  --bg:#f5f6fa; --card:#fff; --muted:#7d8794; --primary:#007bff; --text:#222;
  --dark-bg:#2c3e50; --dark-card:#34495e; --dark-text:#ecf0f1;
}
body{
  font-family: Arial, sans-serif;
  margin:20px;
  background:var(--bg);
  color:var(--text);
}
body.dark{ background:var(--dark-bg); color:var(--dark-text); }
h2{ margin:0 0 10px 0; font-size:32px; }
#status{ color:var(--muted); margin-bottom:10px; font-style:italic; }
.topbar{ display:flex; gap:10px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
.btn{ padding:8px 12px; border-radius:6px; border:none; cursor:pointer; }
.btn-primary{ background:var(--primary); color:#fff; }
.btn-secondary{ background:#eee; }
.toggles{ display:flex; gap:12px; align-items:center; }
.toggle{ position:relative; width:50px; height:26px; }
.toggle input{ opacity:0; }
.slider{ position:absolute; inset:0; background:#ccc; border-radius:26px; }
.slider:before{ content:""; position:absolute; left:3px; bottom:3px; width:20px; height:20px; background:#fff; border-radius:50%; }
.toggle input:checked + .slider{ background:var(--primary); }
.toggle input:checked + .slider:before{ transform:translateX(24px); }
#search{ padding:12px; width:420px; max-width:100%; border-radius:8px; border:1px solid #ccc; }
table{ width:100%; border-collapse:collapse; background:var(--card); border-radius:8px; }
th,td{ padding:10px; border-bottom:1px solid #ddd; }
.compact td,.compact th{ padding:6px; font-size:13px; }
.pagination{ margin-top:16px; display:flex; gap:8px; }
.modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:9999; }
.modal{ width:640px; max-width:94%; background:#fff; border-radius:10px; padding:14px; }
#qr-reader{ width:100%; height:360px; background:#000; border-radius:8px; }
.scan-tools{ display:flex; justify-content:space-between; margin-top:10px; }
</style>
</head>

<body>

<div id="status">Loading data...</div>
<h2>Spare Parts Search</h2>

<!-- üîä SOUND UNLOCK HINT -->
<div id="soundHint" style="margin:8px 0;padding:10px;background:#fff3cd;border-radius:8px;text-align:center;display:none;">
  üîä Tap once to enable scan sound
  <br><br>
  <button id="unlockSound" class="btn btn-primary">Enable Sound</button>
</div>

<div class="topbar">
  <button id="btn-scan" class="btn btn-primary">üì∑ Scan</button>
  <button id="btn-refresh" class="btn btn-secondary">‚Üª Refresh</button>
  <div style="flex:1"></div>
  <div class="toggles">
    <label>Dark<br><label class="toggle"><input id="darkToggle" type="checkbox"><span class="slider"></span></label></label>
    <label>Compact<br><label class="toggle"><input id="compactToggle" type="checkbox"><span class="slider"></span></label></label>
  </div>
</div>

<input id="search" placeholder="Search..." />

<table>
<thead>
<tr><th>S.No</th><th>Item</th><th>Part</th><th>Description</th><th>Category</th><th>Qty</th></tr>
</thead>
<tbody id="table-body"></tbody>
</table>

<div class="pagination">
<button id="prev-page" class="btn btn-secondary">Prev</button>
<span id="page-info"></span>
<button id="next-page" class="btn btn-secondary">Next</button>
</div>

<!-- SCANNER MODAL -->
<div id="qr-backdrop" class="modal-backdrop">
  <div class="modal">
    <h3>Scanner</h3>
    <div id="qr-reader"></div>
    <div class="scan-tools">
      <button id="btn-flash" class="btn btn-secondary">üî¶ Flash</button>
      <button id="btn-photo" class="btn btn-secondary">üñºÔ∏è Photo</button>
    </div>
    <br>
    <button id="qr-close" class="btn btn-secondary">Close</button>
  </div>
</div>

<script>
/* ================== DATA ================== */
let items=[],currentPage=1;
const perPage=50;
const SHEETDB_BASE="https://sheetdb.io/api/v1/bykhl1ncapip9";

/* ================== UI ================== */
const statusEl=document.getElementById('status');
function render(){
  const tbody=document.getElementById('table-body');
  tbody.innerHTML="";
  let q=document.getElementById('search').value.toLowerCase();
  let f=items.filter(r=>JSON.stringify(r).toLowerCase().includes(q));
  let start=(currentPage-1)*perPage;
  f.slice(start,start+perPage).forEach((r,i)=>{
    tbody.innerHTML+=`<tr>
      <td>${start+i+1}</td>
      <td>${r["item no"]||""}</td>
      <td>${r["part no"]||""}</td>
      <td>${r["description"]||""}</td>
      <td>${r["category"]||""}</td>
      <td>${r["qty"]||""}</td>
    </tr>`;
  });
  document.getElementById('page-info').innerText=`Page ${currentPage}`;
}
fetch(SHEETDB_BASE).then(r=>r.json()).then(d=>{items=d;render();});

/* ================== üîä SOUND (FIXED) ================== */
const beep = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
beep.volume = 1.0;
beep.preload = "auto";

/* UNLOCK SOUND ‚Äî SAME AUDIO OBJECT */
document.getElementById('unlockSound').addEventListener('click',()=>{
  beep.currentTime=0;
  beep.play().then(()=>{
    document.getElementById('soundHint').style.display='none';
  }).catch(()=>{});
});

/* Show hint on mobile */
if ('ontouchstart' in window || navigator.maxTouchPoints>0){
  document.getElementById('soundHint').style.display='block';
}

/* ================== SCANNER ================== */
let qrScanner,scanLock=false;
document.getElementById('btn-scan').onclick=async()=>{
  document.getElementById('qr-backdrop').style.display='flex';
  const s=document.createElement('script');
  s.src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/minified/html5-qrcode.min.js";
  s.onload=async()=>{
    qrScanner=new Html5Qrcode("qr-reader");
    await qrScanner.start({facingMode:"environment"},{fps:15},
      txt=>{
        if(scanLock) return;
        scanLock=true;
        beep.currentTime=0;
        beep.play().catch(()=>{});
        navigator.vibrate?.(200);
        document.getElementById('search').value=txt;
        render();
        setTimeout(closeQR,300);
      }
    );
  };
  document.head.appendChild(s);
};

function closeQR(){
  document.getElementById('qr-backdrop').style.display='none';
  try{qrScanner.stop();}catch(e){}
  scanLock=false;
}
document.getElementById('qr-close').onclick=closeQR;
</script>

</body>
</html>
