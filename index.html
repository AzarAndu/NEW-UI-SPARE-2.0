<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
<title>Spare Parts Master</title>
<style>
/* =========================================
   CORE VARIABLES & RESET
   ========================================= */
:root {
  /* Colors */
  --bg-body: #f0f2f5;
  --bg-card: #ffffff;
  --text-main: #1a1a1a;
  --text-muted: #666666;
  --border-color: #d1d5db;
  
  /* Brand Colors */
  --primary: #007bff;
  --primary-dark: #0056b3;
  --secondary: #e2e6ea;
  --secondary-dark: #cbd3da;
  --accent: #28a745;
  --accent-dark: #1e7e34;
  
  /* Dimensions */
  --btn-height: 40px;
  --radius: 6px;
  
  /* Dark Mode Overrides */
  --dm-bg-body: #121212;
  --dm-bg-card: #1e1e1e;
  --dm-text-main: #e0e0e0;
  --dm-text-muted: #a0a0a0;
  --dm-border: #333333;
}

* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  background-color: var(--bg-body);
  color: var(--text-main);
  margin: 0;
  padding: 10px;
  line-height: 1.5;
}

/* =========================================
   LAYOUT CONTAINER
   ========================================= */
.app-container {
  max-width: 1200px;
  margin: 0 auto;
  background: var(--bg-card);
  padding: 20px;
  border-radius: var(--radius);
  border: 1px solid var(--border-color);
  /* Static shadow, no animation */
  box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
}

/* Header Section */
.header-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 2px solid var(--border-color);
}

h2 { margin: 0; font-size: 24px; font-weight: 800; letter-spacing: -0.5px; }
#status { font-size: 13px; font-family: monospace; color: var(--text-muted); background: rgba(0,0,0,0.05); padding: 4px 8px; border-radius: 4px; }

/* =========================================
   3D BUTTONS (NO ANIMATION)
   ========================================= */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  height: var(--btn-height);
  padding: 0 16px;
  font-weight: 700;
  font-size: 14px;
  text-transform: uppercase;
  border-radius: var(--radius);
  cursor: pointer;
  border: 1px solid rgba(0,0,0,0.1);
  position: relative;
  /* The 3D Effect */
  border-bottom-width: 4px; 
  margin-bottom: 4px; /* Space for the 3D depth */
  user-select: none;
}

/* Primary Button (Blue) */
.btn-primary {
  background-color: var(--primary);
  color: #fff;
  border-color: var(--primary-dark);
}
.btn-primary:active {
  border-bottom-width: 0;
  margin-top: 4px;
  margin-bottom: 0;
  background-color: var(--primary-dark);
}

/* Secondary Button (Grey) */
.btn-secondary {
  background-color: var(--secondary);
  color: #333;
  border-color: var(--secondary-dark);
}
.btn-secondary:active {
  border-bottom-width: 0;
  margin-top: 4px;
  margin-bottom: 0;
  background-color: var(--secondary-dark);
}

/* Success Button (Green/Add) */
.btn-success {
  background-color: var(--accent);
  color: white;
  border-color: var(--accent-dark);
}
.btn-success:active {
  border-bottom-width: 0;
  margin-top: 4px;
  margin-bottom: 0;
  background-color: var(--accent-dark);
}

/* =========================================
   CONTROLS GRID
   ========================================= */
.controls-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 12px;
  margin-bottom: 15px;
}

/* Search Bar Area */
.search-area {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}

#search {
  flex: 1;
  min-width: 250px;
  height: 44px; /* Taller input */
  padding: 0 15px;
  border: 2px solid var(--border-color);
  border-radius: var(--radius);
  font-size: 16px;
  background: var(--bg-body);
  color: var(--text-main);
}
#search:focus { border-color: var(--primary); }

/* Toggles Section */
.toggles-container {
  display: flex;
  gap: 15px;
  justify-content: flex-end;
  padding: 10px 0;
  border-top: 1px dashed var(--border-color);
  margin-top: 10px;
}

.toggle-wrapper {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  background: rgba(0,0,0,0.03);
  padding: 4px 8px;
  border-radius: 4px;
}

/* Custom Checkbox (No Animation) */
.chk-box {
  appearance: none;
  width: 18px;
  height: 18px;
  border: 2px solid #777;
  border-radius: 3px;
  display: inline-block;
  position: relative;
}
.chk-box:checked {
  background: var(--primary);
  border-color: var(--primary);
}
.chk-box:checked::after {
  content: '‚úî';
  position: absolute;
  color: white;
  font-size: 12px;
  left: 2px;
  top: -1px;
}

/* =========================================
   TABLE STYLES
   ========================================= */
.table-wrapper {
  overflow-x: auto;
  border: 2px solid var(--border-color);
  border-radius: var(--radius);
  margin-bottom: 15px;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
  background: var(--bg-card);
}

th {
  background: #f8f9fa;
  color: #444;
  font-weight: 700;
  text-align: left;
  padding: 12px;
  border-bottom: 2px solid #ddd;
  text-transform: uppercase;
  font-size: 12px;
}

td {
  padding: 12px;
  border-bottom: 1px solid #eee;
  color: var(--text-main);
}

/* Striped Rows */
tr:nth-child(even) { background-color: rgba(0,0,0,0.02); }

/* Highlighting */
td.cell-highlight {
  background-color: #ffeb3b !important;
  color: black !important;
  font-weight: bold;
  border: 2px solid #000;
}

/* Compact Mode */
body.compact td, body.compact th { padding: 6px 8px; font-size: 13px; }

/* =========================================
   DARK MODE
   ========================================= */
body.dark {
  background-color: var(--dm-bg-body);
  color: var(--dm-text-main);
}
body.dark .app-container {
  background-color: var(--dm-bg-card);
  border-color: var(--dm-border);
}
body.dark #search {
  background: #2b2b2b;
  border-color: #444;
  color: #fff;
}
body.dark th {
  background: #252525;
  color: #ccc;
  border-bottom-color: #444;
}
body.dark td { border-bottom-color: #333; }
body.dark tr:nth-child(even) { background-color: rgba(255,255,255,0.03); }
body.dark .header-row { border-bottom-color: #333; }
body.dark .btn-secondary {
  background: #333;
  color: #eee;
  border-color: #111;
}
body.dark .btn-secondary:active { background: #222; }

/* =========================================
   DROPDOWN & MODAL
   ========================================= */
.site-dropdown-container { position: relative; display: inline-block; }
.site-menu {
  display: none;
  position: absolute;
  top: 100%;
  left: 0;
  background: var(--bg-card);
  border: 2px solid var(--text-main);
  z-index: 1000;
  width: 200px;
  box-shadow: 4px 4px 0 rgba(0,0,0,0.2);
}
.site-menu.open { display: block; }
.site-menu div {
  padding: 10px;
  border-bottom: 1px solid #eee;
  cursor: pointer;
}
.site-menu div:hover { background: var(--primary); color: white; }

/* Modal */
.modal-backdrop {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.8);
  display: none;
  align-items: center; justify-content: center;
  z-index: 9999;
}
.modal {
  background: var(--bg-card);
  width: 600px;
  max-width: 95%;
  padding: 20px;
  border-radius: var(--radius);
  border: 2px solid #444;
}
#qr-reader { width: 100%; background: #000; min-height: 300px; margin: 10px 0; }

/* Utility */
.pagination { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
.page-input { width: 60px; padding: 5px; margin-right: 5px; }

</style>
</head>
<body>

<div class="app-container">
  
  <div class="header-row">
    <div>
      <h2>Spare Parts Master</h2>
      <div id="status">System Ready</div>
    </div>
    
    <div style="display:flex; gap:15px;">
        <label class="toggle-wrapper">
          <input id="darkToggle" type="checkbox" class="chk-box"> Dark Mode
        </label>
        <label class="toggle-wrapper">
            <input id="compactToggle" type="checkbox" class="chk-box"> Compact
        </label>
        <label class="toggle-wrapper">
            <input id="readToggle" type="checkbox" class="chk-box" checked> 
            <span id="readToggleLabel">Laptop Read ON</span>
        </label>
    </div>
  </div>

  <div class="controls-grid">
    <button id="btn-scan" class="btn btn-primary">üì∑ Scan QR</button>
    <button id="btn-add" class="btn btn-success">‚ûï Add Part</button>
    <button id="btn-refresh" class="btn btn-secondary">‚Üª Refresh Data</button>
    
    <div class="site-dropdown-container">
        <button id="btn-sites" class="btn btn-primary" style="width:100%">üîç Search Sites ‚ñº</button>
        <div id="site-menu" class="site-menu">
            <div data-site="partsouq">üß© Partsouq</div>
            <div data-site="spareto">üõ† Spareto</div>
            <div data-site="sumarauto">üöó Sumarauto</div>
            <div data-site="fitin-google">üîé FitinParts (Google)</div>
        </div>
    </div>
  </div>

  <div class="search-area">
    <input id="search" type="text" placeholder="Search Part No, Desc, Category..." autocomplete="off">
    <button id="btn-clear" class="btn btn-secondary" title="Clear">‚úñ</button>
    <button id="btn-google" class="btn btn-secondary">G</button>
    <button id="btn-lens" class="btn btn-secondary">üì∑ Lens</button>
    <button id="btn-send" class="btn btn-secondary">üì§ Send to Laptop</button>
  </div>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th style="width:50px">#</th>
          <th>Item No</th>
          <th>Part No</th>
          <th>Description</th>
          <th>Category</th>
          <th style="width:60px">Qty</th>
        </tr>
      </thead>
      <tbody id="table-body">
        </tbody>
    </table>
  </div>

  <div class="pagination">
    <button id="prev-page" class="btn btn-secondary">Previous</button>
    <span id="page-info" style="font-weight:bold; padding:0 10px;">Page 1</span>
    <button id="next-page" class="btn btn-secondary">Next</button>
    <div style="flex:1"></div>
    <input id="jumpPage" type="number" class="page-input" placeholder="Pg #">
    <button onclick="jumpToPage()" class="btn btn-secondary" style="height:32px; padding:0 10px;">Go</button>
  </div>

</div>

<div id="qr-backdrop" class="modal-backdrop">
  <div class="modal">
    <h3 style="margin-top:0">Scanner</h3>
    <div id="qr-reader"></div>
    <div style="display:flex; justify-content:space-between; margin-top:10px;">
      <div>
          <button id="btn-flash" class="btn btn-secondary">üî¶ Flash</button>
          <button id="btn-photo" class="btn btn-secondary">üñºÔ∏è File</button>
      </div>
      <button id="qr-close" class="btn btn-primary">Close</button>
    </div>
  </div>
</div>

<script>
/* =========================================
   CONFIGURATION & STATE
   ========================================= */
const SYNC_URL = "https://script.google.com/macros/s/AKfycbxLxQCxMx7ZR13YieRVn8OZHyu8Mm-3uu5ydtWogmQcwhYc6I6jMP6cEGQU9GRWsUXF/exec";
const SHEETDB_BASE = "https://sheetdb.io/api/v1/bvdsyfvkla1lv";
const CACHE_KEY = "sheetdb_cache_v1";

let items = [];
let currentPage = 1;
const perPage = 50;
let autoReadEnabled = true;
let lastRowId = null;
let scanLock = false;
let qrScanner = null;
let torchOn = false;
let html5QrcodeLoaded = false;
const beep = new Audio("./ding.mp3");

// DOM Elements
const els = {
    status: document.getElementById('status'),
    search: document.getElementById('search'),
    tbody: document.getElementById('table-body'),
    pageInfo: document.getElementById('page-info'),
    prevBtn: document.getElementById('prev-page'),
    nextBtn: document.getElementById('next-page'),
    siteMenu: document.getElementById('site-menu'),
    qrReader: document.getElementById('qr-reader'),
    qrBackdrop: document.getElementById('qr-backdrop'),
    readLabel: document.getElementById('readToggleLabel')
};

/* =========================================
   THEME & INITIALIZATION
   ========================================= */
const isDark = localStorage.getItem('darkMode') === 'true';
const isCompact = localStorage.getItem('compactMode') === 'true';

document.body.classList.toggle('dark', isDark);
document.body.classList.toggle('compact', isCompact);
document.getElementById('darkToggle').checked = isDark;
document.getElementById('compactToggle').checked = isCompact;

// Toggle Listeners
document.getElementById('darkToggle').onchange = (e) => {
    document.body.classList.toggle('dark', e.target.checked);
    localStorage.setItem('darkMode', e.target.checked);
};
document.getElementById('compactToggle').onchange = (e) => {
    document.body.classList.toggle('compact', e.target.checked);
    localStorage.setItem('compactMode', e.target.checked);
};
document.getElementById('readToggle').onchange = (e) => {
    autoReadEnabled = e.target.checked;
    els.readLabel.textContent = autoReadEnabled ? "Laptop Read ON" : "Laptop Read OFF";
};

/* =========================================
   DATA LOGIC
   ========================================= */
const cleanKeys = row => {
    const fixed = {};
    for (const k in row) fixed[k.trim()] = String(row[k]).trim();
    return fixed;
};

async function loadData(force = false) {
    els.status.textContent = "Loading Data...";
    if (!force) {
        const cached = sessionStorage.getItem(CACHE_KEY);
        if (cached) {
            items = JSON.parse(cached);
            els.status.textContent = `Ready: ${items.length} Records (Cached)`;
            render();
            return;
        }
    }
    try {
        const res = await fetch(SHEETDB_BASE, { cache: "no-store" });
        const data = await res.json();
        items = data.map(cleanKeys);
        sessionStorage.setItem(CACHE_KEY, JSON.stringify(items));
        els.status.textContent = `Ready: ${items.length} Records`;
        render();
    } catch {
        els.status.textContent = "Offline Mode / Error";
    }
}

/* =========================================
   RENDERING
   ========================================= */
function display(list, startIndex) {
    els.tbody.textContent = "";
    const frag = document.createDocumentFragment();
    list.forEach((r, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${startIndex + i + 1}</td>
            <td>${r["item no"] || ""}</td>
            <td>${r["part no"] || ""}</td>
            <td>${r["description"] || ""}</td>
            <td>${r["category"] || ""}</td>
            <td>${r["qty"] || ""}</td>
        `;
        frag.appendChild(tr);
    });
    els.tbody.appendChild(frag);
}

function render() {
    const q = els.search.value.toLowerCase().trim();
    const words = q ? q.split(/\s+/) : [];
    
    const filtered = !words.length ? items : items.filter(r => {
        const text = Object.values(r).join(" ").toLowerCase();
        return words.every(w => text.includes(w));
    });

    const totalPages = Math.max(1, Math.ceil(filtered.length / perPage));
    currentPage = Math.min(currentPage, totalPages);
    const start = (currentPage - 1) * perPage;

    display(filtered.slice(start, start + perPage), start);
    
    els.pageInfo.textContent = `Page ${currentPage} / ${totalPages}`;
    els.prevBtn.disabled = currentPage === 1;
    els.nextBtn.disabled = currentPage === totalPages;
}

window.jumpToPage = () => {
    const p = +document.getElementById('jumpPage').value;
    if (p > 0) { currentPage = p; render(); }
};

/* =========================================
   EVENT LISTENERS
   ========================================= */
// Search Inputs
els.search.oninput = () => { currentPage = 1; render(); };
document.getElementById('btn-clear').onclick = () => { els.search.value = ""; currentPage = 1; render(); };
els.prevBtn.onclick = () => { if(currentPage > 1) { currentPage--; render(); }};
els.nextBtn.onclick = () => { currentPage++; render(); };
document.getElementById('btn-refresh').onclick = () => loadData(true);

// External Actions
document.getElementById("btn-add").onclick = () => window.open("https://docs.google.com/forms/d/e/1FAIpQLSdYtCErU2QugovcnGLHkPOd_G0owZKzYadJdXXgaxwa9ZGegg/viewform", "_blank");

document.getElementById("btn-google").onclick = () => {
    if(!els.search.value) return;
    window.open("https://www.google.com/search?q=" + encodeURIComponent(els.search.value), "_blank");
};

document.getElementById("btn-lens").onclick = () => {
    window.location.href = "intent://search/#Intent;scheme=googleapp;package=com.google.android.googlequicksearchbox;end";
};

document.getElementById("btn-send").onclick = () => {
    const val = els.search.value.trim();
    if (!val) return;
    fetch(SYNC_URL + "?write=" + encodeURIComponent(val))
        .then(() => alert("Sent to Laptop ‚úî"))
        .catch(() => alert("Failed to send"));
};

// Site Menu
document.getElementById('btn-sites').onclick = (e) => {
    e.stopPropagation();
    els.siteMenu.classList.toggle('open');
};
document.addEventListener('click', (e) => {
    if(!e.target.closest('.site-dropdown-container')) els.siteMenu.classList.remove('open');
});
els.siteMenu.onclick = (e) => {
    const q = els.search.value.trim();
    if(!q || !e.target.dataset.site) return;
    let url = "";
    switch (e.target.dataset.site) {
        case "partsouq": url = "https://partsouq.com/en/search/all?q=" + encodeURIComponent(q); break;
        case "spareto": url = "https://spareto.com/products?keywords=" + encodeURIComponent(q); break;
        case "sumarauto": url = "https://www.sumarauto.com/"; break;
        case "fitin-google": url = "https://www.google.com/search?q=" + encodeURIComponent("site:fitinpart.sg " + q); break;
    }
    window.open(url, "_blank");
};

// Table Click to Search
els.tbody.onclick = (e) => {
    const cell = e.target.closest("td");
    if (!cell) return;
    const text = cell.textContent.trim();
    if (text.length < 3) return;
    
    els.search.value = text;
    currentPage = 1; 
    render();
    
    // Highlight
    setTimeout(() => {
        Array.from(els.tbody.querySelectorAll("td")).forEach(c => {
            if(c.textContent === text) {
                c.classList.add("cell-highlight");
                setTimeout(() => c.classList.remove("cell-highlight"), 1000);
            }
        });
    }, 50);
};

/* =========================================
   SYNC LOGIC (POLLING)
   ========================================= */
if (!/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
    setInterval(async () => {
        if (!autoReadEnabled) return;
        try {
            const res = await fetch(SYNC_URL + "?read=latest&_=" + Date.now(), { cache: "no-store" });
            const data = await res.json();
            if (data && data.value && data.row !== lastRowId) {
                lastRowId = data.row;
                els.search.value = data.value;
                currentPage = 1;
                render();
                autoReadEnabled = false; // Pause after read
                document.getElementById('readToggle').checked = false;
                els.readLabel.textContent = "Laptop Read OFF";
            }
        } catch(e) { console.warn("Sync err", e); }
    }, 3000);
}

/* =========================================
   SCANNER LOGIC (Load on demand)
   ========================================= */
async function loadScannerLib() {
    if(html5QrcodeLoaded) return;
    return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = "https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js";
        s.onload = () => { html5QrcodeLoaded = true; resolve(); };
        s.onerror = reject;
        document.head.appendChild(s);
    });
}

function stopScanner() {
    if(qrScanner) {
        qrScanner.stop().then(() => qrScanner.clear()).catch(()=>{});
        qrScanner = null;
    }
    els.qrBackdrop.style.display = 'none';
    torchOn = false;
}

document.getElementById('btn-scan').onclick = async () => {
    els.qrBackdrop.style.display = 'flex';
    scanLock = false;
    els.qrReader.innerHTML = "";
    
    try {
        await loadScannerLib();
        qrScanner = new Html5Qrcode("qr-reader");
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        
        await qrScanner.start({ facingMode: "environment" }, config, (decodedText) => {
            if (scanLock) return;
            scanLock = true;
            beep.play().catch(()=>{});
            if(navigator.vibrate) navigator.vibrate(200);
            
            els.search.value = decodedText;
            currentPage = 1;
            render();
            stopScanner();
        }, () => {});
    } catch(e) {
        alert("Camera Error: " + e);
        stopScanner();
    }
};

document.getElementById('qr-close').onclick = stopScanner;

document.getElementById('btn-flash').onclick = async () => {
    if(!qrScanner) return;
    torchOn = !torchOn;
    try {
        await qrScanner.applyVideoConstraints({ advanced: [{ torch: torchOn }] });
    } catch(e) { alert("Flash not supported"); }
};

document.getElementById('btn-photo').onclick = () => {
    stopScanner();
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = async (e) => {
        if(!e.target.files[0]) return;
        try {
            await loadScannerLib();
            const instance = new Html5Qrcode("qr-reader"); // temp instance
            const res = await instance.scanFile(e.target.files[0], true);
            els.search.value = res;
            render();
        } catch { alert("No code found in image"); }
    };
    input.click();
};

// Initial Load
loadData();

</script>
</body>
</html>
