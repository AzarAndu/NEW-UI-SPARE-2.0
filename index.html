<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Spare Parts Data</title>

<style>
/* ===== Mixed UI: clean new look + restored features ===== */
:root{
  --bg:#f5f6fa; --card:#fff; --muted:#7d8794; --primary:#007bff; --text:#222;
  --dark-bg:#2c3e50; --dark-card:#34495e; --dark-text:#ecf0f1;
}
body{
  font-family: Arial, sans-serif;
  margin:20px;
  background:var(--bg);
  color:var(--text);
  transition: background .2s,color .2s;
}
body.dark{ background:var(--dark-bg); color:var(--dark-text); }
h2{ margin:0 0 10px 0; font-size:32px; color:inherit; }
#status{ color:var(--muted); margin-bottom:10px; font-style:italic; }

.topbar{ display:flex; gap:10px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
.btn{ padding:8px 12px; border-radius:6px; border:none; cursor:pointer; }
.btn-primary{ background:var(--primary); color:#fff; }
.btn-secondary{ background:#eee; color:#222; }

.toggles{ display:flex; gap:12px; align-items:center; margin-left:6px; }
.toggle{ position:relative; width:50px; height:26px; display:inline-block; }
.toggle input{ opacity:0; width:0; height:0; }
.slider{ position:absolute; inset:0; background:#ccc; border-radius:26px; transition:0.2s; }
.slider:before{ content:""; position:absolute; left:3px; bottom:3px; width:20px; height:20px; background:#fff; border-radius:50%; transition:0.2s; }
.toggle input:checked + .slider{ background:var(--primary); }
.toggle input:checked + .slider:before{ transform:translateX(24px); }

#search{ padding:12px; width:420px; max-width:100%; border-radius:8px; border:1px solid #ccc; margin:10px 0; }

table{ width:100%; border-collapse:collapse; background:var(--card); border-radius:8px; overflow:hidden; }
th{ background:#e6e9f0; padding:10px; text-align:left; border-bottom:1px solid #dcdde1; }
td{ padding:10px; border-bottom:1px solid #efefef; }

.compact td,.compact th{ padding:6px; font-size:13px; }

.pagination{ margin-top:16px; display:flex; align-items:center; gap:8px; }

.modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; z-index:9999; }
.modal{ width:640px; max-width:94%; background:var(--card); border-radius:10px; padding:14px; max-height:86vh; overflow:hidden; display:flex; flex-direction:column; }
.modal-header{ font-size:18px; color:#666; }
#qr-reader{ width:100%; height:360px; background:#000; display:flex; align-items:center; justify-content:center; color:#999; border-radius:8px; }
.scan-tools{ display:flex; justify-content:space-between; gap:10px; margin-top:10px; align-items:center; }
.scan-btn{ padding:10px 14px; border-radius:6px; border:1px solid var(--primary); background:#fff; color:var(--primary); cursor:pointer; }
.modal-footer{ text-align:right; margin-top:10px; }
.modal-body{ overflow:auto; flex:1; }

body.dark .modal{ background:var(--dark-card); color:var(--dark-text); }

@media (max-width:600px){
  .modal{ width:94%; padding:10px; }
  #qr-reader{ height:260px; }
}
</style>
</head>
<body>

<div id="status">Loading data...</div>

<h2>Spare Parts Search</h2>

<div class="topbar">
  <button id="btn-scan" class="btn btn-primary">üì∑ Scan (QR / Barcode)</button>
  <button id="btn-refresh" class="btn btn-secondary">‚Üª Refresh</button>

  <div style="flex:1"></div>

  <div class="toggles">
    <label style="display:flex;flex-direction:column;align-items:center;font-size:12px;">
      <div style="margin-bottom:6px;">Dark</div>
      <label class="toggle"><input id="darkToggle" type="checkbox"><span class="slider"></span></label>
    </label>

    <label style="display:flex;flex-direction:column;align-items:center;font-size:12px;">
      <div style="margin-bottom:6px;">Compact</div>
      <label class="toggle"><input id="compactToggle" type="checkbox"><span class="slider"></span></label>
    </label>
  </div>
</div>

<input id="search" type="text" placeholder="Search part / description / category / qty">

<table>
  <thead>
    <tr>
      <th>S.No</th>
      <th>Item No</th>
      <th>Part No</th>
      <th>Description</th>
      <th>Category</th>
      <th>Qty</th>
    </tr>
  </thead>
  <tbody id="table-body"></tbody>
</table>

<div class="pagination">
  <button id="prev-page" class="btn btn-secondary">Prev</button>
  <span id="page-info"></span>
  <button id="next-page" class="btn btn-secondary">Next</button>
</div>

<br>

<input id="jumpPage" type="number" placeholder="Go to page">
<button onclick="jumpToPage()" class="btn btn-secondary">Go</button>

<div id="qr-backdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal">
    <div class="modal-body">
      <h3 class="modal-header">Scanner (QR + Barcode)</h3>

      <div id="qr-reader">Camera preview will appear here</div>

      <div class="scan-tools">
        <div style="display:flex;gap:8px;">
          <button id="btn-flash" class="scan-btn">üî¶ Flash</button>
          <button id="btn-photo" class="scan-btn">üñºÔ∏è Scan From Photo</button>
        </div>
        <div style="font-size:13px;color:#666;">Tip: center code inside the preview</div>
      </div>
    </div>

    <div class="modal-footer">
      <button id="qr-close" class="btn btn-secondary">Close</button>
    </div>
  </div>
</div>

<script>
/* ===================== ORIGINAL APP / SHEETDB LOGIC ===================== */

let items = [];
let currentPage = 1;
const perPage = 50;

let isDark = localStorage.getItem('darkMode') === 'true';
let isCompact = localStorage.getItem('compactMode') === 'true';

if(isDark) document.body.classList.add('dark');
if(isCompact) document.body.classList.add('compact');

document.getElementById('darkToggle').checked = isDark;
document.getElementById('compactToggle').checked = isCompact;

function toggleDark(){ isDark=!isDark; document.body.classList.toggle('dark',isDark); localStorage.setItem('darkMode',isDark); }
function toggleCompact(){ isCompact=!isCompact; document.body.classList.toggle('compact',isCompact); localStorage.setItem('compactMode',isCompact); }

document.getElementById('darkToggle').addEventListener('change', toggleDark);
document.getElementById('compactToggle').addEventListener('change', toggleCompact);

const SHEETDB_BASE = "https://sheetdb.io/api/v1/bykhl1ncapip9";

const mockData = [
  { "item no":"0720","part no":"0720","description":"0720 AC CONDENSOR NIS PICK UP 02-09","category":"AC PARTS ITEMS","qty":"0" },
  { "item no":"4060-ZC026","part no":"44060-ZC026/SP1512","description":"44060-ZC026 BRAKE PAD RR NIS ARMADA 07-","category":"BRAKE PAD","qty":"25.5" }
];

function cleanKeys(r){ let o={}; for(let k in r) o[k.trim()] = (r[k]+"").trim(); return o; }

function display(list){
  const tbody = document.getElementById('table-body');
  tbody.innerHTML = "";
  const start = (currentPage-1)*perPage;
  const h = ['S.No','Item No','Part No','Description','Category','Qty'];

  list.forEach((r,i)=>{
    tbody.innerHTML += `
    <tr>
      <td>${start+i+1}</td>
      <td>${r["item no"]||""}</td>
      <td>${r["part no"]||""}</td>
      <td>${r["description"]||""}</td>
      <td>${r["category"]||""}</td>
      <td>${r["qty"]||""}</td>
    </tr>`;
  });
}

function render(){
  const q = document.getElementById('search').value.toLowerCase();
  const words = q.split(" ").filter(v=>v);

  const filtered = items.filter(r=>{
    const t = (r["item no"]+" "+r["part no"]+" "+r["description"]+" "+r["category"]+" "+r["qty"]).toLowerCase();
    return words.every(w=>t.includes(w));
  });

  const total = Math.max(1, Math.ceil(filtered.length/perPage));
  if(currentPage>total) currentPage=total;

  display(filtered.slice((currentPage-1)*perPage, currentPage*perPage));

  document.getElementById('page-info').innerText = `Page ${currentPage} of ${total}`;
  document.getElementById('prev-page').disabled = currentPage===1;
  document.getElementById('next-page').disabled = currentPage===total;
}

document.getElementById('search').addEventListener('input', ()=>{ currentPage=1; render(); });
document.getElementById('prev-page').addEventListener('click', ()=>{ if(currentPage>1) currentPage--; render(); });
document.getElementById('next-page').addEventListener('click', ()=>{ currentPage++; render(); });

function jumpToPage(){
  const p = parseInt(document.getElementById('jumpPage').value);
  if(!isNaN(p)&&p>0){ currentPage=p; render(); }
}

function loadData(){
  status.innerText = "Fetching records...";
  fetch(SHEETDB_BASE).then(r=>r.json()).then(data=>{
    items = data.map(cleanKeys);
    status.innerText = "Loaded "+items.length+" records.";
    render();
  }).catch(()=>{
    status.innerText = "Offline mode: using sample data.";
    items = mockData;
    render();
  });
}
loadData();

document.getElementById('btn-refresh').addEventListener('click', loadData);


/* ===================== SCANNER ENGINE ===================== */

let html5QrcodeLoaded = false;
let qrScanner = null;
let scanLock = false;
let torchOn = false;

const beep = new Audio("data:audio/mp3;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQCAAwACAAACAgACcQCAAwACAAACAgACcQCAAwACAAACAgACcQCAAwACAAACAgACcQCAAwACAAACAgACcQCAAwACAAACAgACH5BAEAAAIALAAAAAAQABAAAAj/AAMIDBASFCQoMGDDhQoMHBwsQAAOw==");

function safeClearScanner(){
  if(qrScanner){
    qrScanner.stop().then(()=>{
      try{ qrScanner.clear(); }catch(e){}
    }).catch(()=>{});
  }
  qrScanner = null;
  torchOn = false;
}

async function loadHtml5QrcodeScript(){
  if(html5QrcodeLoaded) return;

  /* LOCAL */
  try{
    await new Promise((res,rej)=>{
      const s=document.createElement('script');
      s.src="./html5-qrcode.min.js";
      s.onload=()=>{html5QrcodeLoaded=true;res();};
      s.onerror=()=>{s.remove();rej();};
      document.head.appendChild(s);
    });
    return;
  }catch(e){}

  /* RAW GITHUB */
  try{
    const host=location.hostname;
    const parts=location.pathname.split("/").filter(Boolean);
    let raw="https://raw.githubusercontent.com/mebjas/html5-qrcode/master/dist/html5-qrcode.min.js";

    if(host.endsWith("github.io") && parts.length>0){
      raw=`https://raw.githubusercontent.com/${host.split('.')[0]}/${parts[0]}/main/html5-qrcode.min.js`;
    }

    const txt = await fetch(raw).then(r=>r.text());
    const sc=document.createElement('script');
    sc.text=txt;
    document.head.appendChild(sc);
    html5QrcodeLoaded=true;
    return;
  }catch(e){}

  /* CDN */
  await new Promise((res,rej)=>{
    const s=document.createElement('script');
    s.src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/minified/html5-qrcode.min.js";
    s.onload=()=>{html5QrcodeLoaded=true;res();};
    s.onerror=()=>rej();
    document.head.appendChild(s);
  });
}


/* ===================== PATCHED openQR() ===================== */

async function openQR(){
  qrBackdrop.style.display='flex';
  qrBackdrop.setAttribute('aria-hidden','false');

  /* AUDIO UNLOCK (Samsung / iOS fix) */
  try{
    beep.volume = 0.01;
    await beep.play().catch(()=>{});
    beep.volume = 1.0;
  }catch(e){}

  scanLock=false;
  safeClearScanner();
  qrReader.innerHTML="";

  await new Promise(r => requestAnimationFrame(()=>setTimeout(r,200)));

  try{ await loadHtml5QrcodeScript(); }
  catch(e){
    alert("Scanner library failed to load.");
    qrBackdrop.style.display='none';
    return;
  }

  try{
    qrScanner = new Html5Qrcode("qr-reader");

    const config = {
      fps:15,
      qrbox:null,
      experimentalFeatures:{ useBarCodeDetectorIfSupported:true },
      formatsToSupport:[
        Html5QrcodeSupportedFormats.QR_CODE,
        Html5QrcodeSupportedFormats.EAN_13,
        Html5QrcodeSupportedFormats.EAN_8,
        Html5QrcodeSupportedFormats.UPC_A,
        Html5QrcodeSupportedFormats.CODE_128
      ]
    };

    await qrScanner.start(
      { facingMode:"environment" },
      config,
      decodedText=>{
        if(scanLock) return;
        scanLock=true;
        beep.play().catch(()=>{});
        search.value = decodedText;
        currentPage=1;
        render();
        setTimeout(()=>closeQR(),250);
      },
      ()=>{}
    );

  }catch(err){
    alert("Camera failed to start.");
    qrBackdrop.style.display='none';
    safeClearScanner();
  }
}

btn-scan.onclick=openQR;
qr-close.onclick=closeQR;

async function setTorch(on){
  try{
    const video = qrReader.querySelector('video');
    const track = video.srcObject.getVideoTracks()[0];
    const caps = track.getCapabilities();
    if(caps.torch){
      await track.applyConstraints({ advanced:[{torch:on}] });
      torchOn=on;
      return true;
    }
  }catch(e){}
  return false;
}

btn-flash.onclick=async()=>{
  if(!qrScanner){ alert("Open scanner first"); return; }
  const ok = await setTorch(!torchOn);
  if(!ok) alert("Flash not supported.");
};


/* ===================== PHOTO SCAN ENGINE ===================== */

btn-photo.onclick = ()=>{
  const input=document.createElement('input');
  input.type='file';
  input.accept='image/*';
  input.style.display='none';

  input.onchange=async e=>{
    const file=e.target.files?.[0];
    if(!file) return;

    const reader=new FileReader();
    reader.onload=async()=>{
      try{ await handleImageFile(file); }
      catch(e){ alert("No QR or barcode found."); }
    };
    reader.readAsArrayBuffer(file);
  };

  document.body.appendChild(input);
  input.click();
  input.addEventListener('blur',()=>input.remove());
};


async function handleImageFile(file){

  try{ await loadHtml5QrcodeScript(); }catch(e){}

  /* 1) html5-qrcode scanFile */
  try{
    if(qrScanner?.scanFile){
      const r=await qrScanner.scanFile(file,true);
      if(r){
        beep.play().catch(()=>{});
        search.value=r;
        currentPage=1;
        render();
        return;
      }
    } else if(typeof Html5Qrcode==="function"){
      const tmp=new Html5Qrcode();
      const r=await tmp.scanFile(file,true).catch(()=>null);
      if(r){
        beep.play().catch(()=>{});
        search.value=r;
        currentPage=1;
        render();
        try{tmp.clear();}catch(e){}
        return;
      }
      try{tmp.clear();}catch(e){}
    }
  }catch(e){}


  /* 2) BarcodeDetector */
  try{
    if("BarcodeDetector" in window){
      const formats=["ean_13","ean_8","upc_a"];
      let det;
      try{ det=new BarcodeDetector({formats}); }
      catch{ det=new BarcodeDetector(); }

      const bmp=await createImageBitmap(file);
      const res=await det.detect(bmp);

      if(res.length){
        const v = res[0].rawValue || res[0].displayValue;
        if(v){
          beep.play().catch(()=>{});
          search.value=v;
          currentPage=1;
          render();
          return;
        }
      }
    }
  }catch(e){}


  /* 3) fallback canvas scan */
  try{
    const img=document.createElement('img');
    img.src=URL.createObjectURL(file);
    await new Promise((res,rej)=>{ img.onload=res; img.onerror=rej; });

    if(typeof Html5Qrcode==="function"){
      const tmp=new Html5Qrcode();
      const r=await tmp.scanFile(file,true).catch(()=>null);
      if(r){
        beep.play().catch(()=>{});
        search.value=r;
        currentPage=1;
        render();
        try{tmp.clear();}catch(e){}
        img.remove();
        return;
      }
      try{tmp.clear();}catch(e){}
    }
    img.remove();
  }catch(e){}

  throw new Error("not-found");
}


window.addEventListener('beforeunload', safeClearScanner);
window.addEventListener('pagehide', safeClearScanner);

</script>
</body>
</html>
